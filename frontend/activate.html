<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ ุชูุนูู ุงูุญุณุงุจ - Xtractor Pro</title>
    <link rel="stylesheet" href="css/auth.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <!-- Logo Section -->
            <div class="logo-section">
                <div class="logo-icon">๐</div>
                <h1>Xtractor Pro</h1>
                <p>ูุธุงู ูุชูุงูู ูุฅุฏุงุฑุฉ ููุนุงูุฌุฉ ูููุงุช Excel</p>
            </div>

            <!-- Form Section -->
            <div class="form-section">
                <h2>ุชูุนูู ุงูุญุณุงุจ</h2>
                <p class="subtitle">ุฃุฏุฎู ููุฏ ุงูุชูุนูู ุงูุฐู ุญุตูุช ุนููู ูู ุงููุทูุฑ</p>
                
                <form id="activateForm">
                    <div class="form-group">
                        <label for="activationCode">๐ ููุฏ ุงูุชูุนูู</label>
                        <input 
                            type="text" 
                            id="activationCode" 
                            name="activationCode" 
                            required 
                            placeholder="XXXX-XXXX-XXXX"
                            maxlength="14"
                            autocomplete="off"
                        >
                        <small>ุฃุฏุฎู ุงูููุฏ ุงููููู ูู 12 ุฑูู ูุญุฑู</small>
                    </div>

                    <button type="submit" class="btn-primary" id="activateBtn">
                        <span>โ ุชูุนูู ุงูุญุณุงุจ</span>
                        <div class="spinner" style="display: none;"></div>
                    </button>

                    <div class="divider">
                        <span>ุฃู</span>
                    </div>

                    <div class="register-link">
                        <p>ูุฏูู ุญุณุงุจ ููุนูุ <a href="/login">ุณุฌู ุงูุฏุฎูู</a></p>
                        <p>ููุณ ูุฏูู ุญุณุงุจุ <a href="/register">ุณุฌู ุงูุขู</a></p>
                    </div>
                </form>

                <!-- Alert Messages -->
                <div id="alertMessage" class="alert" style="display: none;"></div>
            </div>

            <!-- Info Box -->
            <div class="info-box">
                <h3>๐ก ูุตุงุฆุญ ูุงูุฉ</h3>
                <ul>
                    <li>ุงุญุตู ุนูู ููุฏ ุงูุชูุนูู ูู ุงููุทูุฑ ูุจุงุดุฑุฉ</li>
                    <li>ุงูููุฏ ุตุงูุญ ููุฑุฉ ูุงุญุฏุฉ ููุท</li>
                    <li>ุชุฃูุฏ ูู ุฅุฏุฎุงู ุงูููุฏ ุจุดูู ุตุญูุญ</li>
                    <li>ููุญุตูู ุนูู ููุฏ ุฌุฏูุฏุ ุชูุงุตู ูุน ุงููุทูุฑ</li>
                </ul>
            </div>

            <!-- Footer -->
            <div class="auth-footer">
                <p>Developed by Eng. Ahmed Waked</p>
                <p>๐ง eng.ahmed.a.waked@gmail.com</p>
                <p>v3.0 Ocean Edition</p>
            </div>
        </div>

        <!-- Background Animation -->
        <div class="ocean-animation">
            <div class="wave wave1"></div>
            <div class="wave wave2"></div>
            <div class="wave wave3"></div>
        </div>
    </div>

    <script>
        // Auto-format activation code input
        const activationCodeInput = document.getElementById('activationCode');
        activationCodeInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
            if (value.length > 12) value = value.substring(0, 12);
            
            // Format as XXXX-XXXX-XXXX
            let formatted = '';
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) formatted += '-';
                formatted += value[i];
            }
            
            e.target.value = formatted;
        });

        // Activate form submission
        document.getElementById('activateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const activationCode = document.getElementById('activationCode').value.trim();
            const activateBtn = document.getElementById('activateBtn');
            const spinner = activateBtn.querySelector('.spinner');

            if (!activationCode) {
                showAlert('error', 'โ ููุฏ ุงูุชูุนูู ูุทููุจ');
                return;
            }

            // Validate code format
            const codeWithoutDashes = activationCode.replace(/-/g, '');
            if (codeWithoutDashes.length !== 12) {
                showAlert('error', 'โ ููุฏ ุงูุชูุนูู ูุฌุจ ุฃู ูููู 12 ุฑูู ูุญุฑู');
                return;
            }

            // Show loading
            activateBtn.disabled = true;
            spinner.style.display = 'inline-block';

            try {
                // Get user ID from localStorage (saved during registration)
                const pendingUserId = localStorage.getItem('pending_user_id');
                
                if (!pendingUserId) {
                    showAlert('error', 'โ ูุฑุฌู ุงูุชุณุฌูู ุฃููุงู ูุจู ุงูุชูุนูู');
                    setTimeout(() => {
                        window.location.href = '/register';
                    }, 2000);
                    return;
                }

                const response = await fetch('/api/auth/activate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: pendingUserId,
                        activation_code: activationCode
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', 'โ ' + result.message + ' ุฌุงุฑู ุงูุชุญููู...');
                    
                    // Clear pending user
                    localStorage.removeItem('pending_user_id');
                    
                    // Redirect to login page
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    showAlert('error', 'โ ' + (result.error || 'ูุดู ุงูุชูุนูู'));
                }
            } catch (error) {
                console.error('Activation error:', error);
                showAlert('error', 'โ ุญุฏุซ ุฎุทุฃ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู');
            } finally {
                activateBtn.disabled = false;
                spinner.style.display = 'none';
            }
        });

        function showAlert(type, message) {
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.className = `alert alert-${type}`;
            alertMessage.textContent = message;
            alertMessage.style.display = 'block';
            
            setTimeout(() => {
                alertMessage.style.display = 'none';
            }, 6000);
        }
    </script>
</body>
</html>
